# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools

default_platform(:ios)

platform :ios do
  desc "Build iOS IPA"
  lane :build_ipa do
    flutter_build_ios(
      build_number: ENV["BUILD_NUMBER"] || "1",
      export_method: "app-store"
    )
  end

  desc "Deploy to TestFlight"
  lane :beta do
    # Setup provisioning profiles and certificates
    setup_ci if ENV['CI']
    
    match(
      type: "appstore",
      readonly: true
    )

    # Build the app
    flutter_build_ios(
      build_number: ENV["BUILD_NUMBER"] || "1",
      export_method: "app-store"
    )

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      ipa: "../build/ios/ipa/flutter_interview_ssr.ipa"
    )
  end

  desc "Deploy to App Store"
  lane :production do
    # Setup provisioning profiles and certificates
    setup_ci if ENV['CI']
    
    match(
      type: "appstore",
      readonly: true
    )

    # Build the app
    flutter_build_ios(
      build_number: ENV["BUILD_NUMBER"] || "1",
      export_method: "app-store"
    )

    # Upload to App Store
    upload_to_app_store(
      ipa: "../build/ios/ipa/flutter_interview_ssr.ipa",
      skip_metadata: false,
      skip_screenshots: false,
      submit_for_review: false,
      automatic_release: false
    )
  end

  desc "Run tests"
  lane :test do
    run_tests(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      device: "iPhone 15"
    )
  end

  # Private helper functions
  private_lane :flutter_build_ios do |options|
    sh("cd ../.. && flutter build ios --release --no-codesign --build-number=#{options[:build_number]}")
    
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: options[:export_method],
      output_directory: "../build/ios/ipa",
      output_name: "flutter_interview_ssr.ipa"
    )
  end
end
